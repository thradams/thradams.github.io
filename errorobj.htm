<!DOCTYPE html
   PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
   <title>Thiago's website</title>
   <link href="trastyle.css" type="text/css" rel="stylesheet" />
   <link rel="alternate" type="application/rss+xml" title="RSS" href="http://wwww.thradams/codeblog/rss.xml" />
</head>

<body>
   <div class="pageheader">

      <h2>Thiago R. Adams website</h2>
      <p>
         <a class="linkbox" href="index.htm">HOME</a>
         <a class="linkbox" href="codeblog.htm">CODE-BLOG</a>
         <a class="linkbox" href="about.htm">ABOUT</a>
         <br />
      </p>
   </div>

   <article>
  
      <!-- Page content begin -->
<h1> Error object</h1>

<p>We need this when error codes are insufficient.</p>

<pre>
<span class="keyword">#include</span> &lt;stdio.h&gt;
<span class="keyword">#include</span> &lt;stdarg.h&gt; 
<span class="keyword">#include</span> &lt;assert.h&gt;
<span class="keyword">#include</span> &lt;assert.h&gt;

<span class="keyword">struct</span> error
{
    <span class="keyword">char</span>* message;
    <span class="keyword">int</span> capacity;
    <span class="keyword">int</span> code;
};

<span class="comment">/*
  The seterror function returns the number of characters that are written,
  not counting the terminating null character. 
  
  If the buffer size specified by er-&gt;capacity isn't sufficiently large to contain 
  the output specified by format and argptr, the return value of seterror is the 
  number of characters that would be written, not counting the null character, 
  if er-&gt;capacity were sufficiently large.
  
  If the return value is greater than count - 1, the output has been truncated. 
  
  A return value of -1 indicates that an encoding error has occurred.
*/</span>
<span class="keyword">int</span> seterror(<span class="keyword">struct</span> error* er, _In_z_ _Printf_format_string_  <span class="keyword">const</span> <span class="keyword">char</span>* fmt, ...)
{
    <span class="comment">/*the usage follow a pattern that the error is set just once*/</span>
    assert(er-&gt;message[<span class="number">0</span>] == <span class="number">0</span>);
    assert(er-&gt;code == <span class="number">0</span>);
    assert(er-&gt;capacity &gt;= <span class="number">0</span>);

    er-&gt;code = <span class="number">1</span>;

    va_list args;
    va_start(args, fmt);
    <span class="keyword">int</span> n = vsnprintf(er-&gt;message, er-&gt;capacity, fmt, args);
    va_end(args);
  
    <span class="keyword">return</span> n;
}

<span class="keyword">void</span> clearerror(<span class="keyword">struct</span> error* err)
{
    err-&gt;code = <span class="number">0</span>;
    err-&gt;message[<span class="number">0</span>] = <span class="number">0</span>;
}

<span class="keyword">int</span> F(<span class="keyword">struct</span> error* err)
{
    <span class="keyword">if</span> (<span class="number">1</span>)
    {
        seterror(err, <span class="string">&quot;some error&quot;</span>);
    }
    <span class="keyword">return</span> err-&gt;code;
}

<span class="keyword">int</span> main()
{
    <span class="keyword">struct</span> error err = { .message = (<span class="keyword">char</span>[<span class="number">100</span>]) {<span class="number">0</span>}, .capacity = <span class="number">100</span> };
    
    <span class="keyword">if</span> (F(&amp;err) != <span class="number">0</span>)
    {
       printf(<span class="string">&quot;%s&quot;</span>, err.message);
    }
} 

</pre>


<p>Getting the error message from windows GetLastError</p>
<pre>
  FormatMessageA(FORMAT_MESSAGE_FROM_SYSTEM, <span class="string">&quot;&quot;</span>, GetLastError(), <span class="number">0</span>, err-&gt;message, err-&gt;capacity, NULL);        
</pre>


<p>Getting the error message from errno. </p>

<pre>
   
   strerror_s(err-&gt;message, err-&gt;capacity, errno);   
</pre>



<!-- Page content end --> 
</article> 
 
</body> 
</html>  